## ELASTICSEARCH的分布式高可用集群

----------

### elasticsearch的集群结构（图见笔记）

> `master node `
>
> > 整个集群的大脑（管理者），会经过选举（Bully算法）
>
> > 最终选举出一个集群的master，维护集群中所有数据的元数据信息
> >
> > 元数据
> >
> > > 分片大小
> > >
> > > 从分片的个数
> > >
> > > 主从分片对应的存储节点
> > >
> > > 分片对应的索引文件等等
>
> `date node`
>
> > 负责读写数据，管理数据分片
>
> `ingest node`
>
> > 对外访问的连接节点
> >
> > 内部通信其他节点实现数据的对外读写
>
> `协调器`
>
> > 创建和运行集群，实现各种集群状态的同步工作
> >
> > 只要保证高可用即可，不需要大量协调器存在



### 搭建一个三个节点的集群

> 准备3个可以启动elasticsearch的节点
>
> > 注：
> >
> > >  分词器要统一
>
> > 略

> 所有集群节点都要配置==协调器==
>
> > `vim /home/software/elasticsearch-5.5.2/config/elasticsearch.yml`
> >
> > > 第69行
> > >
> > > > `discovery.zen.ping.unicast.hosts: ["10.9.39.13", "10.9.104.1"]`
>
> 为了防止脑裂，配置最小集群master的有效数量
>
> > 有效数量多与集群一半，可有效防止脑裂
>
> > 第73行
> >
> > > `discovery.zen.minimum_master_nodes: 2`



##### 启动观察集群的自动发现，自动整合的效果

> 通过集群天生分布式高可用的功能,可以自定义分片数量和副本数量提高并发计算能力,提供高可用能力
>
> 指定该节点是否存储索引数据，默认为true。
>
> > `index.number_of_shards: 5`
> >
> > > 设置默认索引分片个数，默认为5片。
>
> > `index.number_of_replicas: 1`
> >
> > > 数据备份个数，如果只有一台机器，设置为0
>
> 适当的提高分片数量:可以实现更高的并发读写,并发计算
>
> 适当提高副本数量:可以实现更高可用的集群效果



###### 脑裂

> 脑裂的产生
>
> > master集群出现的波动，导致原来没有宕机的节点被判断宕机
> >
> > 集群中出现多个master 管理的情况
> >
> > 导致元数据不稳定，最终影响数据的使用
>
> es中可以通过过半的master最小有效数量,防止脑裂的出现



###### 集群的选举

> 一个集群中为了防止一个master宕机，导致整个集群不可用
>
> 没有服务器维护元数据的情况发生，一般配置多个master同在
>
> 会经过选举的逻辑(Bully算法)

> 1.master节点启动连接协调器(能连接任何一个都算成功
>
> > - 获取集群的所有节点信息
>
> 2.判断协调器传递的一个值 activeMaster(记录了现役master的节点信息)
>
> > - 判断activeMaster非空的,说明master已经选举完毕(终结点)
> >
> > - 判断activeMaster为空,进入第三步
>
> 3.将本节点和其他当前系统的所有master节点存放到一个后备list中candidateMaster
>
> 4.判断候选人中的节点个数是否满足最小master个数
>
> > - 满足最小数量 进入第五步
> > - 不满足最小数量 返回第一步
>
> 5.当数量满足candidateMaster有足够的master候选人,选择其中id值最小值成为暂定的activeMaster,重新返回第一步执行



###### 宕机逻辑

> 协调器只要不全宕机全程管理所有节点相互连接通信
>
>  
>
> 现役master宕机es01宕机
>
> > activeMaster协调器清空
> >
> > es02/es03 第一步-->第二步(空)-->第三步(后备master es02 es03)
> >
> > -->第四步判断(2满足最小个数)-->第五步(选取id最小为暂定master)
>
> 后备master宕机
>
> > es02宕机 es01和es03发现宕机,现在集群中后备master+activeMaster满足最小数量2
> >
> > es03宕机 es01activeMaster无效了,继续进入第一步-–>第二步-–>第三步-–>第一步,直到有一个节点恢复



### 附录

> ES配置文件详解

